<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bienvenido</title>
</head>
<body>

    <h2>Bienvenido!</h2>
    <p id="usernameDisplay"></p>
    <p id="timeDisplay"></p>

    <button onclick="logout()">Cerrar Sesión</button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtengo el token almacenado
            const token = localStorage.getItem('authToken');

            // Si no hay token, redirigir
            if (!token) {
                // Si no está autenticado, redirige al index
                window.location.href = 'index.html'; 
                return;
            }

            // llama al endpoint con una llamada get
            fetch('api_welcome.php', {
                method: 'GET',
                headers: {
                    //Envio el token a la cabecera de autenticación
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                // Manejo la respuesta en el servidor
                if (response.status === 403) {
                    // Redifur a página prohibida
                    window.location.href = 'forbidden.html';
                    return Promise.reject('Token inválido o caducado, acceso denegado.');
                }
                if (!response.ok) {
                    throw new Error('Error al obtener datos del usuario.');
                }
                return response.json();
            })
            .then(data => {
                // Muestro datos del usuario
                if (data.status === 'ok') {
                    document.getElementById('welcomeMessage').textContent = '¡Qué alegría verte de nuevo!'; 
                    document.getElementById('usernameDisplay').textContent = 
                        `Usuario autenticado: ${data.username}`; // Mensaje personalizado con el nombre 
                    document.getElementById('timeDisplay').textContent = 
                        `Hora actual del servidor: ${data.current_time}`; // Hora actual 
                } else {
                    document.getElementById('welcomeMessage').textContent = 'Error al cargar los datos de bienvenida.';
                }
            })
            .catch(error => {
                console.error('Error al acceder a la API protegida:', error);
                // Si hay un error elimino el token
                if (error !== 'Token inválido o caducado, acceso denegado.') {
                    localStorage.removeItem('authToken');
                    window.location.href = 'index.html'; 
                }
            });
        });

        //Cerrar sesión
        function logout() {
            //Elimino el token del localStorage
            localStorage.removeItem('authToken');
            // Redirigir al usuario al login
            window.location.href = 'index.html';
        }
    </script>

</body>
</html>